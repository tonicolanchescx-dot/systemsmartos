<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartOS - Enterprise V17</title>
    <meta name="google" content="notranslate">
    <meta name="googlebot" content="notranslate">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>

    <style>
        .animate-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        * { -webkit-tap-highlight-color: transparent; }
        input, select, textarea { font-size: 16px !important; }
        
        /* Padr√£o de Senha */
        .pattern-container { position: relative; width: 180px; margin: 0 auto; user-select: none; }
        .pattern-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .pattern-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; position: relative; z-index: 10; padding: 10px; }
        .pattern-dot { width: 40px; height: 40px; border-radius: 50%; background: white; border: 2px solid #cbd5e1; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #64748b; cursor: pointer; transition: all 0.2s; }
        .pattern-dot.active { background: #2563eb; border-color: #2563eb; color: white; transform: scale(1.1); }
        .pattern-dot.readonly { cursor: default; }

        @media print {
            body * { visibility: hidden; }
            #receipt-content, #receipt-content * { visibility: visible; }
            #receipt-overlay { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; padding: 0; margin: 0; z-index: 9999; overflow: visible; display: block !important; }
            #receipt-content { width: 100%; max-width: 100%; padding: 20px; box-shadow: none; border: none; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans selection:bg-blue-100">
    <div id="root"></div>

    <!-- Boot: carrega deps via ESM e executa o app (JSX) via Babel preset React classic -->
    <script type="module">
      const log = (()=>{});
      try {
        log('Carregando depend√™ncias‚Ä¶');

        const ReactMod = await import('https://esm.sh/react@18.2.0');
        const React = ReactMod.default ?? ReactMod;

        const ReactDOMClient = await import('https://esm.sh/react-dom@18.2.0/client');

        const Lucide = await import('https://esm.sh/lucide-react@0.263.1');

        const ChartJS = await import('https://esm.sh/chart.js@4.4.1');

        const FBApp = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const FBAuth = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        const FBFS   = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        window.__deps = {
          React,
          ...React,
          createRoot: ReactDOMClient.createRoot,
          Lucide,
          ChartJS,
          firebase: {
            ...FBApp,
            ...FBAuth,
            ...FBFS
          }
        };

        log('Deps OK ‚úÖ');

        // Espera Babel carregar
        if (!window.Babel) {
          log('Babel n√£o carregou ‚ùå');
          throw new Error('Babel ausente');
        }

        const src = document.getElementById('app-src').textContent;

        // Compila JSX -> React.createElement (runtime classic)
        let compiled;
        try {
          compiled = window.Babel.transform(src, {
          // ‚úÖ env + react (corrige sintaxes modernas e evita bug targets.esmodules)
          presets: [
            [window.Babel.availablePresets['env'], { targets: { esmodules: true } }],
            [window.Babel.availablePresets['react'], { runtime: 'classic' }]
          ],
          sourceType: 'script'
        }).code;
        } catch (err) {
          log('BABEL ERROR ‚ùå: ' + (err?.message || err));
          if (err?.codeFrame) log(err.codeFrame);
          throw err;
        }

        log('JSX compilado ‚úÖ');

        // Executa o c√≥digo compilado em um escopo com deps
        const deps = window.__deps;
        const fn = new Function('deps', `
          const React = deps.React;
          const { useState, useEffect, useMemo, useRef } = deps;
          const createRoot = deps.createRoot;

          const Lucide = deps.Lucide;
          const ChartJS = deps.ChartJS;
          const {
            LayoutDashboard, ClipboardList, Plus, Search, LogOut, Wrench,
            Smartphone, Laptop, DollarSign, CheckCircle2, Clock, AlertCircle,
            X, User, Save, Trash2, Edit, Lock, Mail, Eye, EyeOff, Calendar, Share2, AlertTriangle,
            Power, BatteryCharging, Wifi, Camera, ShieldAlert, TrendingUp, Store, Megaphone, Hammer, CreditCard, Banknote, PenSquare, Gift, Printer, FileText, ShieldCheck, Timer, Users, UserPlus, Phone, Briefcase
          } = Lucide;

          const {
            initializeApp, deleteApp,
            getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut,
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, serverTimestamp, orderBy
          } = deps.firebase;

          ${compiled}
        `);
        fn(deps);

        log('App executado ‚úÖ');
      } catch (e) {
        const msg = (e && (e.stack || e.message)) ? (e.stack || e.message) : String(e);
        (window.__debugLog || console.error)('BOOT ERROR ‚ùå: ' + msg);
        console.error(e);
      }
    </script>

    <script id="app-src" type="text/plain">
// --- CONFIGURA√á√ÉO (CLIENTE-SMART) ---
        const firebaseConfig = {
          apiKey: "AIzaSyBhnLc-4Be_09G4IWdUhSrthg7sZjlRI78",
          authDomain: "cliente-smart.firebaseapp.com",
          projectId: "cliente-smart",
          storageBucket: "cliente-smart.firebasestorage.app",
          messagingSenderId: "727892558558",
          appId: "1:727892558558:web:18f8ed6b0ca80304c7784f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- HELPER DE GARANTIA ---
        const getWarrantyInfo = (dateExit, days) => {
            if (!dateExit || !days || days === '0') return null;
            const exit = new Date(dateExit); exit.setHours(12, 0, 0, 0); 
            const expiry = new Date(exit); expiry.setDate(exit.getDate() + parseInt(days));
            const today = new Date(); today.setHours(0, 0, 0, 0); 
            const expiryCheck = new Date(expiry); expiryCheck.setHours(0,0,0,0);
            const isExpired = today > expiryCheck;
            const daysLeft = Math.ceil((expiryCheck - today) / (1000 * 60 * 60 * 24));
            return {
                expiryDate: expiry.toLocaleDateString('pt-BR'),
                isExpired,
                daysLeft,
                label: isExpired ? `Expirou em ${expiry.toLocaleDateString('pt-BR')}` : `Vence em ${expiry.toLocaleDateString('pt-BR')}`,
                daysLabel: `${days} Dias`
            };
        };

        // --- COMPONENTES UI ---
        const Button = ({ children, onClick, variant = 'primary', className = '', type = 'button', disabled = false }) => {
            const base = "px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 active:scale-95 touch-manipulation shadow-sm";
            const variants = {
                primary: "bg-blue-600 text-white shadow-blue-500/30 hover:bg-blue-700",
                secondary: "bg-white text-gray-700 border border-gray-200 hover:bg-gray-50",
                danger: "bg-red-50 text-red-600 hover:bg-red-100",
                destructive: "bg-red-600 text-white shadow-red-500/30 hover:bg-red-700",
                success: "bg-green-600 text-white hover:bg-green-700 shadow-green-500/30"
            };
            return <button type={type} onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${disabled ? 'opacity-50 grayscale' : ''} ${className}`}>{children}</button>;
        };

        const StatusBadge = ({ status }) => {
            const styles = { 'Aberto': 'bg-blue-100 text-blue-700', 'Em An√°lise': 'bg-purple-100 text-purple-700', 'Aguardando Pe√ßa': 'bg-orange-100 text-orange-700', 'Conclu√≠do': 'bg-green-100 text-green-700', 'Cancelado': 'bg-red-100 text-red-700' };
            return <span className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider border ${styles[status] || 'bg-gray-100 text-gray-600'}`}>{status}</span>;
        };

        const WarrantyBadge = ({ dateExit, days }) => {
            const info = getWarrantyInfo(dateExit, days);
            if (!info) return null;
            return <div className={`flex items-center gap-1 text-[10px] font-bold px-2 py-0.5 rounded border ${info.isExpired ? 'bg-gray-100 text-gray-500 border-gray-200' : 'bg-emerald-50 text-emerald-600 border-emerald-200'}`}>{info.isExpired ? <Clock size={10}/> : <ShieldCheck size={10}/>}{info.label}</div>;
        };


        const RevenueChart = ({ revenue = 0, cost = 0, extras = 0, profit = 0, periodLabel = '' }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;
                if (!ChartJS || !ChartJS.Chart) return;

                const { Chart, registerables } = ChartJS;

                // Registra m√≥dulos do Chart.js uma √∫nica vez
                if (!window.__chartjs_registered) {
                    try { Chart.register(...registerables); } catch (e) {}
                    window.__chartjs_registered = true;
                }

                // Destroi gr√°fico anterior (evita duplicar)
                if (chartRef.current) {
                    try { chartRef.current.destroy(); } catch (e) {}
                    chartRef.current = null;
                }

                chartRef.current = new Chart(canvasRef.current, {
                    type: 'bar',
                    data: {
                        labels: ['Faturamento', 'Pe√ßas', 'Extras', 'Lucro'],
                        datasets: [{
                            label: 'R$',
                            data: [revenue, cost, extras, profit]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                        const v = (ctx.parsed && typeof ctx.parsed.y === 'number') ? ctx.parsed.y : 0;
                                        return ' ' + new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => {
                                        try { return Number(value).toLocaleString('pt-BR'); } catch (e) { return value; }
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        try { chartRef.current.destroy(); } catch (e) {}
                        chartRef.current = null;
                    }
                };
            }, [revenue, cost, extras, profit, periodLabel]);

            return (
                <div className="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm">
                    <div className="flex items-center justify-between mb-3">
                        <div>
                            <div className="text-[10px] uppercase tracking-wider text-gray-400 font-bold">Gr√°fico do per√≠odo</div>
                            <div className="font-extrabold text-slate-800">{periodLabel || '-'}</div>
                        </div>
                        <span className="text-[10px] font-bold uppercase tracking-wider text-gray-400">Data Sa√≠da</span>
                    </div>
                    <div className="h-52">
                        <canvas ref={canvasRef}></canvas>
                    </div>
                </div>
            );
        };


        const PatternLock = ({ value = [], onChange, readOnly = false }) => {
            const getCoords = (index) => { const col = index % 3; const row = Math.floor(index / 3); return { x: 30 + col * 60, y: 30 + row * 60 }; };
            const handleDotClick = (index) => { if (readOnly) return; const sel = value.indexOf(index); onChange(sel !== -1 ? value.filter(i => i !== index) : [...value, index]); };
            return (
                <div className="flex flex-col items-center"><div className="pattern-container"><svg className="pattern-svg">{value.map((dotIndex, i) => { if (i === value.length - 1) return null; const s = getCoords(dotIndex); const e = getCoords(value[i + 1]); return <line key={i} x1={s.x} y1={s.y} x2={e.x} y2={e.y} stroke="#2563eb" strokeWidth="4" strokeLinecap="round" />; })}</svg><div className="pattern-grid">{[0, 1, 2, 3, 4, 5, 6, 7, 8].map(i => { const order = value.indexOf(i); return <div key={i} className={`pattern-dot ${order !== -1 ? 'active' : ''} ${readOnly ? 'readonly' : ''}`} onClick={() => handleDotClick(i)}>{order !== -1 ? order + 1 : ''}</div>; })}</div></div>{!readOnly && <p className="text-xs text-gray-400 mt-2">Toque na sequ√™ncia</p>}</div>
            );
        };

        const CheckItem = ({ label, icon: Icon, checked, onChange, readOnly }) => (
            <div onClick={() => !readOnly && onChange(!checked)} className={`flex flex-col items-center justify-center p-3 rounded-xl border transition-all ${!readOnly ? 'cursor-pointer active:scale-95' : 'cursor-default opacity-80'} ${checked ? 'bg-red-50 border-red-200 text-red-600' : 'bg-gray-50 border-gray-100 text-gray-400'}`}><Icon size={24} className="mb-1" /><span className="text-[10px] font-bold uppercase text-center leading-tight">{label}</span>{checked && <span className="text-[10px] font-bold text-red-500 mt-1">SIM</span>}</div>
        );

        // --- APP ---
        function SmartOSApp() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('login'); 
            const [orders, setOrders] = useState([]);
            const [filteredOrders, setFilteredOrders] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            // Filtro de per√≠odo na aba ORDENS
            const [ordersTimeFilter, setOrdersTimeFilter] = useState('month');
            const [ordersPeriodOffset, setOrdersPeriodOffset] = useState(0);
            const [ordersDateField, setOrdersDateField] = useState('dateEntry'); // 'dateEntry' (entrada) ou 'dateExit' (sa√≠da)
            const [ordersStatusFilter, setOrdersStatusFilter] = useState('all'); // all | Aberto | Em An√°lise | Aguardando Pe√ßa | Conclu√≠do | Cancelado
            const [ordersSort, setOrdersSort] = useState('recent'); // recent | oldest | valueDesc | valueAsc
            useEffect(() => { setOrdersPeriodOffset(0); }, [ordersTimeFilter, ordersDateField]);
            const [timeFilter, setTimeFilter] = useState('month');
            const [periodOffset, setPeriodOffset] = useState(0); // 0 = atual, -1 = anterior, +1 = pr√≥ximo
            useEffect(() => { setPeriodOffset(0); }, [timeFilter]); 
            const [teamMembers, setTeamMembers] = useState([]);
            // Relat√≥rio de destina√ß√£o do lucro (modal)
            const [profitReport, setProfitReport] = useState(null);

            
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalMode, setModalMode] = useState('view');
            const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
            const [itemToDelete, setItemToDelete] = useState(null);
            const [receiptData, setReceiptData] = useState(null);
            
            const [visiblePasswords, setVisiblePasswords] = useState({});
            const [isUserModalOpen, setIsUserModalOpen] = useState(false);
            
            // ESTADOS DE CRIA√á√ÉO DE USU√ÅRIO (COM CARGO)
            const [newUserEmail, setNewUserEmail] = useState('');
            const [newUserPass, setNewUserPass] = useState('');
            const [newUserRole, setNewUserRole] = useState('Atendente'); // Padr√£o

            const initialForm = { clientName: '', clientPhone: '', deviceType: 'Smartphone', deviceModel: '', problem: '', serviceDone: '', status: 'Aberto', price: '', cost: '', notes: '', dateEntry: new Date().toISOString().split('T')[0], dateExit: '', warrantyDays: '90', passwordType: 'none', passwordText: '', passwordPattern: [], checklist: { wontTurnOn: false, screenBroken: false, backBroken: false, notCharging: false, noWifi: false, cameraBad: false }, payments: [], extraCosts: [] };
            const [formData, setFormData] = useState(initialForm);
            
            const [newPaymentAmount, setNewPaymentAmount] = useState('');
            const [newPaymentMethod, setNewPaymentMethod] = useState('Pix');
            const [newExtraCostDesc, setNewExtraCostDesc] = useState('');
            const [newExtraCostAmount, setNewExtraCostAmount] = useState('');

            const [editingId, setEditingId] = useState(null);
            const [notification, setNotification] = useState(null);
            const [saving, setSaving] = useState(false);
            
            // Login limpo
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(true);

            const isAdmin = user && user.email === 'admin@smartos.com';

            useEffect(() => { const u = onAuthStateChanged(auth, (u) => { setUser(u); if (u) setView('dashboard'); else setView('login'); setLoading(false); }); return () => u(); }, []);
            
            useEffect(() => {
                if (!user) return;
                const qOrders = query(collection(db, 'service_orders'));
                const unsubOrders = onSnapshot(qOrders, (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setOrders(data); setFilteredOrders(data);
                }, (err) => { if(err.code === 'permission-denied') showNotification("Erro de permiss√£o.", "error"); });

                let unsubTeam = () => {};
                if (isAdmin) {
                    const qTeam = query(collection(db, 'team_members'), orderBy('createdAt', 'desc'));
                    unsubTeam = onSnapshot(qTeam, (snap) => {
                        const members = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        setTeamMembers(members);
                    });
                }
                return () => { unsubOrders(); unsubTeam(); };
            }, [user, isAdmin]);

            useEffect(() => {
                // Primeiro filtra por PER√çODO (aba Ordens)
                const today = new Date(); today.setHours(0,0,0,0);

                const addDays = (d, days) => { const x = new Date(d); x.setDate(x.getDate() + days); return x; };
                const addMonths = (d, months) => { const x = new Date(d); x.setMonth(x.getMonth() + months); return x; };
                const addYears = (d, years) => { const x = new Date(d); x.setFullYear(x.getFullYear() + years); return x; };

                const startOfDay = (d) => { const x = new Date(d); x.setHours(0,0,0,0); return x; };
                const startOfWeek = (d) => { const x = startOfDay(d); const dow = x.getDay(); x.setDate(x.getDate() - dow); return x; };
                const startOfMonth = (d) => new Date(d.getFullYear(), d.getMonth(), 1);
                const startOfYear = (d) => new Date(d.getFullYear(), 0, 1);

                let start, end;

                if (ordersTimeFilter === 'day') {
                    const base = addDays(today, ordersPeriodOffset);
                    start = startOfDay(base);
                    end = addDays(start, 1);
                } else if (ordersTimeFilter === 'week') {
                    const base = addDays(today, ordersPeriodOffset * 7);
                    start = startOfWeek(base);
                    end = addDays(start, 7);
                } else if (ordersTimeFilter === 'year') {
                    const base = addYears(today, ordersPeriodOffset);
                    start = startOfYear(base);
                    end = addYears(start, 1);
                } else {
                    const base = addMonths(today, ordersPeriodOffset);
                    start = startOfMonth(base);
                    end = addMonths(start, 1);
                }

                const parseISODate = (ds) => {
                    if (!ds) return null;
                    const parts = (ds || '').split('-').map(Number);
                    if (parts.length !== 3) return null;
                    const [y, m, d] = parts;
                    if (!y || !m || !d) return null;
                    const dt = new Date(y, m - 1, d);
                    dt.setHours(12,0,0,0);
                    return dt;
                };

                // 1) filtro por per√≠odo (usa a "Base" escolhida: Entrada ou Sa√≠da)
                let out = orders.filter(o => {
                    const ds = o[ordersDateField];
                    const dt = parseISODate(ds);
                    if (!dt) return false;
                    return dt >= start && dt < end;
                });

                // 2) filtro por STATUS
                if (ordersStatusFilter !== 'all') {
                    out = out.filter(o => (o.status || '') === ordersStatusFilter);
                }

                // 3) filtro por busca
                if (searchTerm !== '') {
                    const t = searchTerm.toLowerCase();
                    out = out.filter(o =>
                        (o.clientName || '').toLowerCase().includes(t) ||
                        (o.deviceModel || '').toLowerCase().includes(t) ||
                        (o.osNumber && o.osNumber.toString().includes(t))
                    );
                }

                // 4) ordena√ß√£o
                const getSortDate = (o) => {
                    // usa o campo de data selecionado (Entrada/Sa√≠da) como "principal"
                    const dt = parseISODate(o[ordersDateField]);
                    if (dt) return dt.getTime();
                    const created = (o.createdAt?.seconds || 0) * 1000;
                    return created || 0;
                };

                const getValue = (o) => parseFloat(o.price || 0) || 0;

                out = [...out].sort((a, b) => {
                    if (ordersSort === 'oldest') return getSortDate(a) - getSortDate(b);
                    if (ordersSort === 'valueDesc') return getValue(b) - getValue(a);
                    if (ordersSort === 'valueAsc') return getValue(a) - getValue(b);
                    // recent (padr√£o)
                    return getSortDate(b) - getSortDate(a);
                });

                setFilteredOrders(out);
            }, [searchTerm, orders, ordersTimeFilter, ordersPeriodOffset, ordersDateField, ordersStatusFilter, ordersSort]);

            const showNotification = (msg, type = 'success') => { setNotification({ msg, type }); setTimeout(() => setNotification(null), 4000); };
            
            const handleAuth = async (e) => { 
                e.preventDefault(); 
                try { 
                    await signInWithEmailAndPassword(auth, email, password); 
                } catch (err) { 
                    if (err.code === 'auth/configuration-not-found') showNotification("ATIVE o Login no Firebase!", "error"); 
                    else showNotification(err.message, "error"); 
                } 
            };

            // --- CRIA√á√ÉO DE USU√ÅRIO COM CARGO ---
            const handleCreateUser = async (e) => {
                e.preventDefault();
                setSaving(true);
                try {
                    const secondaryApp = initializeApp(firebaseConfig, "Secondary");
                    const secondaryAuth = getAuth(secondaryApp);
                    await createUserWithEmailAndPassword(secondaryAuth, newUserEmail, newUserPass);
                    await signOut(secondaryAuth);
                    
                    // Adiciona na lista com o CARGO
                    await addDoc(collection(db, 'team_members'), { 
                        email: newUserEmail, 
                        password: newUserPass, 
                        role: newUserRole, // Novo campo
                        createdAt: serverTimestamp() 
                    });
                    
                    showNotification(`Colaborador ${newUserEmail} criado!`);
                    setIsUserModalOpen(false); setNewUserEmail(''); setNewUserPass('');
                } catch (err) { showNotification("Erro: " + err.message, "error"); } finally { setSaving(false); }
            };

            const handleDeleteMember = async (id) => {
                if(confirm("Remover da lista?")) {
                    try { await deleteDoc(doc(db, 'team_members', id)); showNotification("Removido."); } catch(e) { showNotification("Erro.", "error"); }
                }
            };

            const togglePassword = (id) => { setVisiblePasswords(prev => ({ ...prev, [id]: !prev[id] })); };

            const handleSave = async (e) => {
                if(e) e.preventDefault();
                if (!user) return;
                if (!formData.clientName || !formData.deviceModel) { showNotification("Nome e Modelo obrigat√≥rios!", "error"); return; }
                setSaving(true);
                try {
                    const ref = collection(db, 'service_orders');
                    let finalDateExit = formData.dateExit;
                    if (formData.status === 'Conclu√≠do' && !finalDateExit) finalDateExit = new Date().toISOString().split('T')[0];
                    const data = { ...formData, price: formData.price || '0', cost: formData.cost || '0', dateExit: finalDateExit, updatedAt: serverTimestamp(), createdBy: user.email };
                    if (editingId) { await updateDoc(doc(db, 'service_orders', editingId), data); showNotification("Atualizado!"); } 
                    else { await addDoc(ref, { ...data, createdAt: serverTimestamp(), osNumber: Math.floor(1000 + Math.random() * 9000) }); showNotification("Criado!"); }
                    setIsModalOpen(false); setFormData(initialForm); setEditingId(null);
                } catch (err) { showNotification("Erro: " + err.code, "error"); } finally { setSaving(false); }
            };

            const addPayment = () => { if (!newPaymentAmount || parseFloat(newPaymentAmount) <= 0) return; setFormData(p => ({ ...p, payments: [...(p.payments || []), { method: newPaymentMethod, amount: parseFloat(newPaymentAmount) }] })); setNewPaymentAmount(''); };
            const removePayment = (index) => { setFormData(p => ({ ...p, payments: p.payments.filter((_, i) => i !== index) })); };
            const addExtraCost = () => { if (!newExtraCostAmount || parseFloat(newExtraCostAmount) <= 0 || !newExtraCostDesc) return; setFormData(p => ({ ...p, extraCosts: [...(p.extraCosts || []), { description: newExtraCostDesc, amount: parseFloat(newExtraCostAmount) }] })); setNewExtraCostDesc(''); setNewExtraCostAmount(''); };
            const removeExtraCost = (index) => { setFormData(p => ({ ...p, extraCosts: p.extraCosts.filter((_, i) => i !== index) })); };
            
            const promptDelete = (id) => { setItemToDelete(id); setIsDeleteModalOpen(true); }
            const confirmDelete = async () => { if (!itemToDelete) return; try { await deleteDoc(doc(db, 'service_orders', itemToDelete)); showNotification("Exclu√≠do."); setIsDeleteModalOpen(false); } catch (err) { showNotification("Erro ao excluir", "error"); } }

            const openNewOS = () => { setEditingId(null); setFormData(initialForm); setModalMode('edit'); setIsModalOpen(true); }
            const openViewOS = (os) => { setEditingId(os.id); setFormData({ ...initialForm, ...os }); setModalMode('view'); setIsModalOpen(true); }
            const openEditOS = (os) => { setEditingId(os.id); setFormData({ ...initialForm, ...os }); setModalMode('edit'); setIsModalOpen(true); }

            const handleWhatsApp = (os) => {
                let text = `Ol√° *${os.clientName}*! üëã\n\nSobre seu *${os.deviceModel}* (OS #${os.osNumber}).\nStatus: *${os.status}*\nValor: R$ ${os.price}\n\nFico √† disposi√ß√£o!`;
                if (os.clientPhone) {
                    const cleanPhone = os.clientPhone.replace(/\D/g, '');
                    const fullPhone = (cleanPhone.length >= 10 && cleanPhone.length <= 11) ? `55${cleanPhone}` : cleanPhone;
                    window.open(`https://wa.me/${fullPhone}?text=${encodeURIComponent(text)}`, '_blank');
                } else {
                    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
                }
            }

            const openReceipt = (os) => { setReceiptData(os); };
            const closeReceipt = () => { setReceiptData(null); };
            const printReceipt = () => { window.print(); };

            const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(parseFloat(val || 0));
            const formatDateBR = (dateString) => { if(!dateString) return '--/--'; const [y, m, d] = dateString.split('-'); return `${d}/${m}/${y}`; };

            // --- EXPORTA√á√ÉO CSV (RELAT√ìRIO POR DATA DE SA√çDA) ---
            const exportCSVByExitDate = () => {
                // usa o per√≠odo da aba ORDENS (Dia/Semana/M√™s/Ano + offset), sempre baseado em dateExit
                const today = new Date(); today.setHours(0,0,0,0);

                const addDays = (d, days) => { const x = new Date(d); x.setDate(x.getDate() + days); return x; };
                const addMonths = (d, months) => { const x = new Date(d); x.setMonth(x.getMonth() + months); return x; };
                const addYears = (d, years) => { const x = new Date(d); x.setFullYear(x.getFullYear() + years); return x; };

                const startOfDay = (d) => { const x = new Date(d); x.setHours(0,0,0,0); return x; };
                const startOfWeek = (d) => { const x = startOfDay(d); const dow = x.getDay(); x.setDate(x.getDate() - dow); return x; };
                const startOfMonth = (d) => new Date(d.getFullYear(), d.getMonth(), 1);
                const startOfYear = (d) => new Date(d.getFullYear(), 0, 1);

                let start, end;
                if (ordersTimeFilter === 'day') {
                    const base = addDays(today, ordersPeriodOffset);
                    start = startOfDay(base);
                    end = addDays(start, 1);
                } else if (ordersTimeFilter === 'week') {
                    const base = addDays(today, ordersPeriodOffset * 7);
                    start = startOfWeek(base);
                    end = addDays(start, 7);
                } else if (ordersTimeFilter === 'year') {
                    const base = addYears(today, ordersPeriodOffset);
                    start = startOfYear(base);
                    end = addYears(start, 1);
                } else {
                    const base = addMonths(today, ordersPeriodOffset);
                    start = startOfMonth(base);
                    end = addMonths(start, 1);
                }

                const parseISODate = (ds) => {
                    if (!ds) return null;
                    const parts = (ds || '').split('-').map(Number);
                    if (parts.length !== 3) return null;
                    const [y, m, d] = parts;
                    if (!y || !m || !d) return null;
                    const dt = new Date(y, m - 1, d);
                    dt.setHours(12,0,0,0);
                    return dt;
                };

                // Relat√≥rio financeiro: somente Conclu√≠dos com dateExit no per√≠odo
                const data = orders.filter(o => {
                    if ((o.status || '') !== 'Conclu√≠do') return false;
                    const dt = parseISODate(o.dateExit);
                    if (!dt) return false;
                    return dt >= start && dt < end;
                });

                if (!data.length) {
                    showNotification('Nenhuma ordem conclu√≠da (com data de sa√≠da) nesse per√≠odo.', 'error');
                    return;
                }

                const sumExtras = (o) => (o.extraCosts || []).reduce((acc, i) => acc + (parseFloat(i.amount) || 0), 0);
                const safe = (v) => {
                    const s = (v ?? '').toString().replace(/\r?\n/g, ' ').trim();
                    // troca " por "" para CSV
                    return `"${s.replace(/"/g, '""')}"`;
                };

                const header = [
                    'OS','Cliente','Telefone','Modelo','Tipo','Entrada','Sa√≠da','Status','Valor','Custo','Extras','Lucro','Criado Por'
                ].join(',');

                const rows = data.map(o => {
                    const price = parseFloat(o.price || 0) || 0;
                    const cost  = parseFloat(o.cost || 0) || 0;
                    const extras = sumExtras(o);
                    const profit = price - cost - extras;

                    return [
                        safe(o.osNumber || ''),
                        safe(o.clientName || ''),
                        safe(o.clientPhone || ''),
                        safe(o.deviceModel || ''),
                        safe(o.deviceType || ''),
                        safe(formatDateBR(o.dateEntry)),
                        safe(formatDateBR(o.dateExit)),
                        safe(o.status || ''),
                        safe(price.toFixed(2)),
                        safe(cost.toFixed(2)),
                        safe(extras.toFixed(2)),
                        safe(profit.toFixed(2)),
                        safe(o.createdBy || '')
                    ].join(',');
                });

                const csv = [header, ...rows].join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);

                const periodLabel = (getOrdersPeriodLabel && typeof getOrdersPeriodLabel === 'function') ? getOrdersPeriodLabel() : 'periodo';
                const filename = `relatorio_saida_${periodLabel.toString().replace(/\s+/g,'_').replace(/\//g,'-')}.csv`;

                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('CSV exportado com sucesso! ‚úÖ');
            };


            
            const getOrdersPeriodLabel = () => {
                const today = new Date(); today.setHours(0,0,0,0);
                const addDays = (d, days) => { const x = new Date(d); x.setDate(x.getDate() + days); return x; };
                const addMonths = (d, months) => { const x = new Date(d); x.setMonth(x.getMonth() + months); return x; };
                const addYears = (d, years) => { const x = new Date(d); x.setFullYear(x.getFullYear() + years); return x; };

                const startOfDay = (d) => { const x = new Date(d); x.setHours(0,0,0,0); return x; };
                const startOfWeek = (d) => { const x = startOfDay(d); const dow = x.getDay(); x.setDate(x.getDate() - dow); return x; };
                const startOfMonth = (d) => new Date(d.getFullYear(), d.getMonth(), 1);
                const startOfYear = (d) => new Date(d.getFullYear(), 0, 1);

                let start, end, label;

                if (ordersTimeFilter === 'day') {
                    const base = addDays(today, ordersPeriodOffset);
                    start = startOfDay(base);
                    end = addDays(start, 1);
                    label = start.toLocaleDateString('pt-BR');
                } else if (ordersTimeFilter === 'week') {
                    const base = addDays(today, ordersPeriodOffset * 7);
                    start = startOfWeek(base);
                    end = addDays(start, 7);
                    const fmt = (dt) => dt.toLocaleDateString('pt-BR');
                    label = `${fmt(start)} ‚Äì ${fmt(addDays(end, -1))}`;
                } else if (ordersTimeFilter === 'year') {
                    const base = addYears(today, ordersPeriodOffset);
                    start = startOfYear(base);
                    end = addYears(start, 1);
                    label = `${start.getFullYear()}`;
                } else {
                    const base = addMonths(today, ordersPeriodOffset);
                    start = startOfMonth(base);
                    end = addMonths(start, 1);
                    label = start.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                    label = label.charAt(0).toUpperCase() + label.slice(1);
                }

                return label;
            };
const stats = useMemo(() => {
                const today = new Date();
                today.setHours(0,0,0,0);

                const addDays = (d, days) => { const x = new Date(d); x.setDate(x.getDate() + days); return x; };
                const addMonths = (d, months) => { const x = new Date(d); x.setMonth(x.getMonth() + months); return x; };
                const addYears = (d, years) => { const x = new Date(d); x.setFullYear(x.getFullYear() + years); return x; };

                const startOfDay = (d) => { const x = new Date(d); x.setHours(0,0,0,0); return x; };
                const startOfWeek = (d) => { const x = startOfDay(d); const dow = x.getDay(); x.setDate(x.getDate() - dow); return x; }; // domingo
                const startOfMonth = (d) => new Date(d.getFullYear(), d.getMonth(), 1);
                const startOfYear = (d) => new Date(d.getFullYear(), 0, 1);

                let start, end, label;

                if (timeFilter === 'day') {
                    const base = addDays(today, periodOffset);
                    start = startOfDay(base);
                    end = addDays(start, 1);
                    label = start.toLocaleDateString('pt-BR');
                } else if (timeFilter === 'week') {
                    const base = addDays(today, periodOffset * 7);
                    start = startOfWeek(base);
                    end = addDays(start, 7);
                    const fmt = (dt) => dt.toLocaleDateString('pt-BR');
                    label = `${fmt(start)} ‚Äì ${fmt(addDays(end, -1))}`;
                } else if (timeFilter === 'year') {
                    const base = addYears(today, periodOffset);
                    start = startOfYear(base);
                    end = addYears(start, 1);
                    label = `${start.getFullYear()}`;
                } else {
                    // month (padr√£o)
                    const base = addMonths(today, periodOffset);
                    start = startOfMonth(base);
                    end = addMonths(start, 1);
                    label = start.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                    label = label.charAt(0).toUpperCase() + label.slice(1);
                }

                const financialOrders = orders.filter(o => {
                    if (o.status !== 'Conclu√≠do' || !o.dateExit) return false;
                    const parts = (o.dateExit || '').split('-').map(Number);
                    if (parts.length !== 3) return false;
                    const [y, m, d] = parts;
                    if (!y || !m || !d) return false;
                    const exitDate = new Date(y, m - 1, d);
                    exitDate.setHours(12,0,0,0);
                    return exitDate >= start && exitDate < end;
                });

                const totalRevenue = financialOrders.reduce((acc, c) => acc + (parseFloat(c.price)||0), 0);
                const totalCost = financialOrders.reduce((acc, c) => acc + (parseFloat(c.cost)||0), 0);
                const totalExtras = financialOrders.reduce((acc, c) => acc + (c.extraCosts || []).reduce((s, i) => s + (parseFloat(i.amount)||0), 0), 0);
                const netProfit = totalRevenue - totalCost - totalExtras;

                const pendingCount = orders.filter(o => o.status !== 'Conclu√≠do' && o.status !== 'Cancelado').length;

                return {
                    total: orders.length,
                    pending: pendingCount,
                    revenue: totalRevenue,
                    cost: totalCost,
                    extras: totalExtras,
                    netProfit: netProfit,
                    completedInPeriod: financialOrders.length,
                    periodLabel: label,
                    split: { store: netProfit * 0.40, tech: netProfit * 0.40, marketing: netProfit * 0.20 }
                };
            }, [orders, timeFilter, periodOffset]);

            // Ordens conclu√≠das no per√≠odo do Dashboard (base: Data de Sa√≠da)
            const financialOrdersInPeriod = useMemo(() => {
                const today = new Date();
                today.setHours(0,0,0,0);

                const addDays = (d, days) => { const x = new Date(d); x.setDate(x.getDate() + days); return x; };
                const addMonths = (d, months) => { const x = new Date(d); x.setMonth(x.getMonth() + months); return x; };
                const addYears = (d, years) => { const x = new Date(d); x.setFullYear(x.getFullYear() + years); return x; };

                const startOfDay = (d) => { const x = new Date(d); x.setHours(0,0,0,0); return x; };
                const startOfWeek = (d) => { const x = startOfDay(d); const dow = x.getDay(); x.setDate(x.getDate() - dow); return x; }; // domingo
                const startOfMonth = (d) => new Date(d.getFullYear(), d.getMonth(), 1);
                const startOfYear = (d) => new Date(d.getFullYear(), 0, 1);

                let start, end;

                if (timeFilter === 'day') {
                    const base = addDays(today, periodOffset);
                    start = startOfDay(base);
                    end = addDays(start, 1);
                } else if (timeFilter === 'week') {
                    const base = addDays(today, periodOffset * 7);
                    start = startOfWeek(base);
                    end = addDays(start, 7);
                } else if (timeFilter === 'year') {
                    const base = addYears(today, periodOffset);
                    start = startOfYear(base);
                    end = addYears(start, 1);
                } else {
                    const base = addMonths(today, periodOffset);
                    start = startOfMonth(base);
                    end = addMonths(start, 1);
                }

                return orders
                    .filter(o => {
                        if (o.status !== 'Conclu√≠do' || !o.dateExit) return false;
                        const parts = (o.dateExit || '').split('-').map(Number);
                        if (parts.length !== 3) return false;
                        const [y, m, d] = parts;
                        if (!y || !m || !d) return false;
                        const exitDate = new Date(y, m - 1, d);
                        exitDate.setHours(12,0,0,0);
                        return exitDate >= start && exitDate < end;
                    })
                    .map(o => {
                        const price = parseFloat(o.price || 0);
                        const cost = parseFloat(o.cost || 0);
                        const extras = (o.extraCosts || []).reduce((s, i) => s + (parseFloat(i.amount)||0), 0);
                        const net = price - cost - extras;
                        return { ...o, __price: price, __cost: cost, __extras: extras, __net: net };
                    });
            }, [orders, timeFilter, periodOffset]);

            const openProfitReport = (target) => {
                const pct = target === 'store' ? 0.40 : target === 'tech' ? 0.40 : 0.20;
                const label = target === 'store' ? 'LOJA (40%)' : target === 'tech' ? 'T√âCNICO (40%)' : 'MARKETING (20%)';

                const rows = financialOrdersInPeriod.map(o => ({
                    id: o.id,
                    osNumber: o.osNumber,
                    clientName: o.clientName,
                    deviceModel: o.deviceModel,
                    dateExit: o.dateExit,
                    price: o.__price,
                    net: o.__net,
                    share: o.__net * pct
                }));

                const totalNet = rows.reduce((a, r) => a + (r.net || 0), 0);
                const totalShare = rows.reduce((a, r) => a + (r.share || 0), 0);

                setProfitReport({ target, label, pct, rows, totalNet, totalShare });
            };

            const closeProfitReport = () => setProfitReport(null);
if (loading) return <div className="min-h-screen flex items-center justify-center bg-slate-900 text-white">Carregando...</div>;

            // --- TELA DE LOGIN ---
            if (!user || view === 'login') return (
                <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-6">
                    <div className="bg-slate-800 w-full max-w-sm p-8 rounded-2xl shadow-2xl border border-slate-700 animate-in">
                        <div className="flex justify-center mb-6"><div className="bg-blue-600 p-4 rounded-xl"><Wrench className="text-white" size={32} /></div></div>
                        <h1 className="text-2xl font-bold text-white text-center mb-2">SmartOS</h1>
                        <p className="text-slate-400 text-center text-xs mb-6">Acesso Restrito</p>
                        
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div className="relative">
                                <Mail className="absolute left-3 top-3 text-slate-500" size={20}/>
                                <input type="email" required className="w-full bg-slate-900 border border-slate-700 text-white rounded-lg py-3 pl-10 pr-4 outline-none focus:border-blue-500" value={email} onChange={e => setEmail(e.target.value)} placeholder="Email" />
                            </div>
                            <div className="relative">
                                <Lock className="absolute left-3 top-3 text-slate-500" size={20}/>
                                <input type="password" required className="w-full bg-slate-900 border border-slate-700 text-white rounded-lg py-3 pl-10 pr-4 outline-none focus:border-blue-500" value={password} onChange={e => setPassword(e.target.value)} placeholder="Senha" />
                            </div>
                            <Button type="submit" className="w-full mt-2 text-base">Entrar</Button>
                        </form>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col bg-gray-50">
                    {notification && <div className={`fixed top-4 left-4 right-4 z-[70] p-4 rounded-xl shadow-xl text-center font-bold text-sm animate-in text-white ${notification.type === 'error' ? 'bg-red-500' : 'bg-green-600'}`}>{notification.msg}</div>}

                    <header className="bg-slate-900 text-white pt-safe-top pb-2 px-4 sticky top-0 z-20 shadow-lg">
                        <div className="flex justify-between items-center py-3">
                            <div className="flex items-center gap-2 font-bold text-lg"><Wrench className="text-blue-500" /> SmartOS <span className="text-xs bg-slate-800 px-2 py-0.5 rounded text-gray-400">{isAdmin ? 'ADMIN' : 'TEC'}</span></div>
                            <button onClick={() => signOut(auth)} className="text-slate-400"><LogOut size={20}/></button>
                        </div>
                        <div className="flex bg-slate-800 p-1 rounded-xl mb-2 overflow-x-auto">
                            <button onClick={() => setView('dashboard')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap transition-all ${view === 'dashboard' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-400'}`}>In√≠cio</button>
                            <button onClick={() => setView('orders')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap transition-all ${view === 'orders' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-400'}`}>Ordens</button>
                            {isAdmin && <button onClick={() => setView('team')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap transition-all ${view === 'team' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-400'}`}>Equipe</button>}
                        </div>
                    </header>

                    <main className="flex-1 p-4 pb-24 overflow-y-auto">
                        {view === 'dashboard' && (
                            <div className="space-y-4 animate-in">
                                <div className="bg-white p-3 rounded-2xl border border-gray-200 shadow-sm space-y-3">
                                    <div className="flex bg-gray-50 p-1 rounded-xl border border-gray-100 overflow-x-auto">
                                        {[{id:'day',l:'Dia'},{id:'week',l:'Semana'},{id:'month',l:'M√™s'},{id:'year',l:'Ano'}].map(f=>(
                                            <button key={f.id} onClick={()=>setTimeFilter(f.id)} className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold whitespace-nowrap ${timeFilter===f.id?'bg-slate-800 text-white':'text-gray-500'}`}>{f.l}</button>
                                        ))}
                                    </div>

                                    <div className="flex items-center justify-between">
                                        <button
                                            onClick={() => setPeriodOffset(o => o - 1)}
                                            className="px-3 py-2 rounded-xl bg-slate-900 text-white font-bold text-sm active:scale-95"
                                            aria-label="Per√≠odo anterior"
                                        >
                                            ‚Äπ
                                        </button>

                                        <div className="text-center">
                                            <div className="text-[10px] uppercase tracking-wider text-gray-400 font-bold">Per√≠odo</div>
                                            <div className="font-extrabold text-slate-800">{stats.periodLabel}</div>
                                            {periodOffset !== 0 && (
                                                <button
                                                    onClick={() => setPeriodOffset(0)}
                                                    className="text-xs font-bold text-blue-600 mt-1"
                                                >
                                                    Voltar para o atual
                                                </button>
                                            )}
                                        </div>

                                        <button
                                            onClick={() => setPeriodOffset(o => o + 1)}
                                            className="px-3 py-2 rounded-xl bg-slate-900 text-white font-bold text-sm active:scale-95"
                                            aria-label="Pr√≥ximo per√≠odo"
                                        >
                                            ‚Ä∫
                                        </button>
                                    </div>
                                </div>
                                <div className="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-3xl shadow-xl text-white relative overflow-hidden">
                                    <div className="relative z-10">
                                        <p className="text-slate-400 text-sm font-bold mb-1 uppercase tracking-wider">Faturamento (Entrou)</p>
                                        <h2 className="text-4xl font-bold tracking-tight mb-2 text-green-400">{formatCurrency(stats.revenue)}</h2>
                                        <div className="flex flex-wrap gap-2">
                                            <span className="bg-blue-500/20 text-blue-300 px-2 py-1 rounded text-xs font-bold border border-blue-500/30">Lucro: {formatCurrency(stats.netProfit)}</span>
                                            <span className="bg-red-500/20 text-red-300 px-2 py-1 rounded text-xs font-bold border border-red-500/30">Pe√ßas: {formatCurrency(stats.cost)}</span>
                                            <span className="bg-orange-500/20 text-orange-300 px-2 py-1 rounded text-xs font-bold border border-orange-500/30">Extras: {formatCurrency(stats.extras)}</span>
                                        </div>
                                        <p className="text-[10px] text-slate-500 mt-2 italic">*Baseado em {stats.completedInPeriod} ordens (Data Sa√≠da)</p>
                                    </div>
                                </div>
                                <RevenueChart revenue={stats.revenue} cost={stats.cost} extras={stats.extras} profit={stats.netProfit} periodLabel={stats.periodLabel} />
                                <h3 className="font-bold text-gray-700 text-sm uppercase tracking-wide mt-2 ml-1">Destina√ß√£o do Lucro</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    <div onClick={() => openProfitReport('store')} className="bg-white p-4 rounded-2xl border border-blue-100 shadow-sm cursor-pointer hover:shadow-md transition active:scale-[0.99]"><span className="text-xs font-bold text-blue-500 block mb-1">LOJA (40%)</span><p className="text-xl font-bold text-gray-800">{formatCurrency(stats.split.store)}</p><p className="text-[10px] font-bold text-gray-400 mt-2 uppercase tracking-wider">Ver relat√≥rio</p></div>
                                    <div onClick={() => openProfitReport('tech')} className="bg-white p-4 rounded-2xl border border-emerald-100 shadow-sm cursor-pointer hover:shadow-md transition active:scale-[0.99]"><span className="text-xs font-bold text-emerald-500 block mb-1">T√âCNICO (40%)</span><p className="text-xl font-bold text-gray-800">{formatCurrency(stats.split.tech)}</p><p className="text-[10px] font-bold text-gray-400 mt-2 uppercase tracking-wider">Ver relat√≥rio</p></div>
                                    <div onClick={() => openProfitReport('marketing')} className="col-span-2 bg-white p-4 rounded-2xl border border-purple-100 shadow-sm flex justify-between items-center cursor-pointer hover:shadow-md transition active:scale-[0.99]"><div><span className="text-xs font-bold text-purple-500">MARKETING (20%)</span><p className="text-[10px] font-bold text-gray-400 mt-1 uppercase tracking-wider">Ver relat√≥rio</p></div><p className="text-xl font-bold text-gray-800">{formatCurrency(stats.split.marketing)}</p></div>
                                </div>
                                <div className="mt-4 bg-orange-50 p-4 rounded-2xl border border-orange-100 flex items-center justify-between"><div className="flex items-center gap-2 text-orange-700"><AlertCircle size={20}/><span className="font-bold text-sm">Pendentes em Aberto</span></div><span className="font-bold text-xl text-orange-800">{stats.pending}</span></div>
                            </div>
                        )}

                        {view === 'orders' && (
                            <div className="animate-in h-full flex flex-col">
                                
<div className="sticky top-0 z-10 bg-gray-50 pb-4">
  <div className="space-y-3">
    <div className="relative">
      <Search className="absolute left-4 top-3.5 text-gray-400" size={20}/>
      <input
        className="w-full bg-white border border-gray-200 shadow-sm rounded-2xl py-3 pl-12 pr-4 text-sm font-medium outline-none focus:ring-2 focus:ring-blue-500"
        placeholder="Buscar por cliente, modelo ou OS..."
        value={searchTerm}
        onChange={e => setSearchTerm(e.target.value)}
      />
    </div>

    <div className="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm space-y-4">
      <div>
        <p className="text-xs font-bold text-gray-400 uppercase mb-1">Base do Filtro</p>
        <div className="flex gap-2">
          {[{ id: 'dateEntry', label: 'Data de Entrada' }, { id: 'dateExit', label: 'Data de Sa√≠da' }].map(opt => (
            <button
              key={opt.id}
              onClick={() => setOrdersDateField(opt.id)}
              className={`flex-1 py-2 rounded-xl text-sm font-bold transition ${ordersDateField === opt.id ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-500'}`}
            >
              {opt.label}
            </button>
          ))}
        </div>
      </div>

      <div>
        <p className="text-xs font-bold text-gray-400 uppercase mb-1">Per√≠odo</p>
        <div className="grid grid-cols-4 gap-2">
          {[{id:'day',l:'Dia'},{id:'week',l:'Semana'},{id:'month',l:'M√™s'},{id:'year',l:'Ano'}].map(f=>(
            <button
              key={f.id}
              onClick={()=>setOrdersTimeFilter(f.id)}
              className={`py-2 rounded-xl text-xs font-bold transition ${ordersTimeFilter===f.id?'bg-slate-900 text-white':'bg-gray-100 text-gray-500'}`}
            >
              {f.l}
            </button>
          ))}
        </div>
      </div>

      <div className="flex items-center justify-between bg-gray-50 p-3 rounded-xl">
        <button
          onClick={() => setOrdersPeriodOffset(o => o - 1)}
          className="px-3 py-2 rounded-xl bg-slate-900 text-white font-bold active:scale-95"
          aria-label="Per√≠odo anterior"
        >
          ‚Äπ
        </button>

        <div className="text-center">
          <p className="text-xs font-bold text-gray-400 uppercase">Per√≠odo Atual</p>
          <p className="font-extrabold text-gray-800">{getOrdersPeriodLabel()}</p>
          {ordersPeriodOffset !== 0 && (
            <button
              onClick={() => setOrdersPeriodOffset(0)}
              className="text-xs font-bold text-blue-600 mt-1"
            >
              Voltar para hoje
            </button>
          )}
        </div>

        <button
          onClick={() => setOrdersPeriodOffset(o => o + 1)}
          className="px-3 py-2 rounded-xl bg-slate-900 text-white font-bold active:scale-95"
          aria-label="Pr√≥ximo per√≠odo"
        >
          ‚Ä∫
        </button>
      </div>


      <div className="grid grid-cols-1 gap-3">
        <div>
          <p className="text-xs font-bold text-gray-400 uppercase mb-1">Status</p>
          <div className="flex gap-2 overflow-x-auto pb-1">
            {[
              { id: 'all', label: 'Todos' },
              { id: 'Aberto', label: 'Aberto' },
              { id: 'Em An√°lise', label: 'Em An√°lise' },
              { id: 'Aguardando Pe√ßa', label: 'Aguard. Pe√ßa' },
              { id: 'Conclu√≠do', label: 'Conclu√≠do' },
              { id: 'Cancelado', label: 'Cancelado' }
            ].map(s => (
              <button
                key={s.id}
                onClick={() => setOrdersStatusFilter(s.id)}
                className={`px-3 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition
                  ${ordersStatusFilter === s.id ? 'bg-slate-900 text-white' : 'bg-gray-100 text-gray-600'}`}
              >
                {s.label}
              </button>
            ))}
          </div>
        </div>

        <div className="flex gap-2">
          <div className="flex-1">
            <p className="text-xs font-bold text-gray-400 uppercase mb-1">Ordenar</p>
            <select
              className="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-sm font-bold outline-none"
              value={ordersSort}
              onChange={(e) => setOrdersSort(e.target.value)}
            >
              <option value="recent">Mais recentes</option>
              <option value="oldest">Mais antigas</option>
              <option value="valueDesc">Maior valor</option>
              <option value="valueAsc">Menor valor</option>
            </select>
          </div>

          <div className="flex flex-col justify-end">
            <Button
              onClick={exportCSVByExitDate}
              variant="secondary"
              className="!px-4 !py-3 !rounded-2xl whitespace-nowrap"
            >
              <FileText size={18}/> CSV (Sa√≠da)
            </Button>
          </div>
        </div>
      </div>

      <div className="text-center text-xs font-bold text-gray-500">
        {filteredOrders.length} ordens encontradas
      </div>
    </div>

    <div className="flex justify-end">
      <Button onClick={openNewOS} className="!px-4 !py-3 !rounded-2xl shadow-sm">
        <Plus size={20} /> Nova OS
      </Button>
    </div>
  </div>
</div>
<div className="space-y-4 pb-20">
                                    {filteredOrders.map(order => (
                                        <div key={order.id} onClick={() => openViewOS(order)} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 active:scale-[0.98] transition-transform relative">
                                            <div className="flex justify-between items-start mb-3">
                                                <div><span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">#{order.osNumber} ‚Ä¢ Ent: {formatDateBR(order.dateEntry)}</span><h3 className="font-bold text-gray-800 text-lg leading-tight">{order.clientName}</h3></div>
                                                <StatusBadge status={order.status} />
                                            </div>
                                            <div className="bg-gray-50 p-3 rounded-xl mb-4">
                                                <div className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-1">{order.deviceType === 'Notebook' ? <Laptop size={14} className="text-blue-500"/> : <Smartphone size={14} className="text-blue-500"/>}{order.deviceModel}</div>
                                                <p className="text-xs text-gray-500 line-clamp-2">{order.problem}</p>
                                            </div>
                                            {order.status === 'Conclu√≠do' && order.dateExit && (<div className="mb-3"><WarrantyBadge dateExit={order.dateExit} days={order.warrantyDays} /></div>)}
                                            <div className="flex justify-between items-center pt-2">
                                                <div className="flex flex-col"><span className="font-bold text-lg text-slate-800">{formatCurrency(order.price)}</span>{order.dateExit && <span className="text-[10px] text-gray-400 font-medium">Sa√≠da: {formatDateBR(order.dateExit)}</span>}</div>
                                                <div className="flex gap-2">
                                                    <button onClick={(e) => { e.stopPropagation(); openReceipt(order); }} className="p-2 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 active:scale-90 transition-transform"><Printer size={20}/></button>
                                                    <button onClick={(e) => { e.stopPropagation(); handleWhatsApp(order); }} className="p-2 bg-green-50 text-green-600 rounded-full hover:bg-green-100 active:scale-90 transition-transform"><Phone size={20}/></button>
                                                    <button onClick={(e) => { e.stopPropagation(); openViewOS(order); }} className="p-2 bg-blue-50 text-blue-600 rounded-full hover:bg-blue-100 active:scale-90 transition-transform"><Eye size={20}/></button>
                                                    <button onClick={(e) => { e.stopPropagation(); openEditOS(order); }} className="p-2 bg-orange-50 text-orange-500 rounded-full hover:bg-orange-100 active:scale-90 transition-transform"><PenSquare size={20}/></button>
                                                    <button onClick={(e) => { e.stopPropagation(); promptDelete(order.id); }} className="p-2 bg-red-50 text-red-500 rounded-full hover:bg-red-100 active:scale-90 transition-transform"><Trash2 size={20}/></button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* --- VIEW: EQUIPE (ATUALIZADO) --- */}
                        {view === 'team' && isAdmin && (
                            <div className="animate-in h-full flex flex-col p-4 overflow-y-auto">
                                <div className="bg-white p-6 rounded-2xl shadow-md border border-gray-100 mb-6">
                                    <div className="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-600"><Users size={24}/></div>
                                    <h3 className="text-xl font-bold text-gray-800 text-center mb-4">Cadastrar Novo Colaborador</h3>
                                    <Button onClick={() => setIsUserModalOpen(true)} className="w-full flex items-center justify-center gap-2"><UserPlus size={20}/> Adicionar Usu√°rio</Button>
                                </div>
                                <h4 className="text-sm font-bold text-gray-500 uppercase mb-3 ml-1">Membros da Equipe</h4>
                                <div className="space-y-3 pb-24">
                                    {teamMembers.map(member => (
                                        <div key={member.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between">
                                            <div className="flex-1">
                                                <div className="flex flex-col mb-2">
                                                    <div className="flex items-center gap-2">
                                                        <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><User size={16}/></div>
                                                        <p className="font-bold text-sm text-gray-800">{member.email}</p>
                                                    </div>
                                                    <span className="ml-10 text-xs font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded-md w-fit">{member.role || 'Atendente'}</span>
                                                </div>
                                                <div className="flex items-center gap-2 text-xs text-gray-500 bg-gray-50 p-2 rounded-lg w-fit ml-10"><Lock size={12} /><span className="font-mono tracking-wider">{visiblePasswords[member.id] ? member.password : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</span><button onClick={() => togglePassword(member.id)} className="ml-2 text-blue-500 hover:text-blue-700">{visiblePasswords[member.id] ? <EyeOff size={14}/> : <Eye size={14}/>}</button></div>
                                            </div>
                                            <button onClick={() => handleDeleteMember(member.id)} className="p-2 text-red-400 hover:bg-red-50 rounded-lg"><Trash2 size={18}/></button>
                                        </div>
                                    ))}
                                    {teamMembers.length === 0 && <p className="text-center text-gray-400 text-sm py-4">Nenhum colaborador na lista.</p>}
                                </div>
                            </div>
                        )}
                    </main>
                    {/* MODAL RELAT√ìRIO DESTINA√á√ÉO DO LUCRO */}
                    {profitReport && (
                        <div className="fixed inset-0 z-[90] bg-black/70 backdrop-blur-sm flex items-end sm:items-center justify-center p-4">
                            <div className="bg-white w-full sm:max-w-2xl rounded-t-3xl sm:rounded-2xl shadow-2xl max-h-[85vh] flex flex-col animate-in">
                                <div className="p-4 border-b flex items-center justify-between">
                                    <div>
                                        <p className="text-xs font-bold text-gray-400 uppercase">Relat√≥rio</p>
                                        <h3 className="text-lg font-extrabold text-gray-800">{profitReport.label}</h3>
                                        <p className="text-xs text-gray-500">Per√≠odo: {stats.periodLabel} ‚Ä¢ Base: Data de Sa√≠da</p>
                                    </div>
                                    <button onClick={closeProfitReport} className="p-2 rounded-full bg-gray-100 text-gray-600 active:scale-95">
                                        <X size={18}/>
                                    </button>
                                </div>

                                <div className="p-4 overflow-y-auto">
                                    {profitReport.rows.length === 0 ? (
                                        <p className="text-sm text-gray-500 text-center py-10">Nenhuma ordem conclu√≠da no per√≠odo.</p>
                                    ) : (
                                        <div className="space-y-3">
                                            {profitReport.rows.map(r => (
                                                <div key={r.id} className="bg-gray-50 border border-gray-100 rounded-2xl p-4">
                                                    <div className="flex items-start justify-between gap-3">
                                                        <div>
                                                            <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">OS #{r.osNumber} ‚Ä¢ Sa√≠da: {formatDateBR(r.dateExit)}</div>
                                                            <div className="font-extrabold text-gray-800">{r.clientName}</div>
                                                            <div className="text-xs text-gray-500">{r.deviceModel}</div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-[10px] font-bold text-gray-400 uppercase">Valor da OS</div>
                                                            <div className="font-extrabold text-slate-900">{formatCurrency(r.price)}</div>
                                                            <div className="mt-2 text-[10px] font-bold text-gray-400 uppercase">Lucro da OS</div>
                                                            <div className="font-extrabold text-slate-900">{formatCurrency(r.net)}</div>
                                                        </div>
                                                    </div>

                                                    <div className="mt-3 flex items-center justify-between bg-white rounded-xl p-3 border border-gray-200">
                                                        <span className="text-xs font-bold text-gray-500 uppercase">Parcela ({Math.round(profitReport.pct * 100)}%)</span>
                                                        <span className="text-lg font-extrabold text-green-700">{formatCurrency(r.share)}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <div className="p-4 border-t bg-white">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <div className="text-[10px] font-bold text-gray-400 uppercase">Total de lucro no per√≠odo</div>
                                            <div className="font-extrabold text-gray-800">{formatCurrency(profitReport.totalNet)}</div>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-[10px] font-bold text-gray-400 uppercase">Total da parcela</div>
                                            <div className="text-2xl font-extrabold text-green-700">{formatCurrency(profitReport.totalShare)}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}


                    {/* MODAL CRIAR USU√ÅRIO (ATUALIZADO COM CARGO) */}
                    {isUserModalOpen && (
                        <div className="fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-in">
                                <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-gray-800">Novo Colaborador</h3><button onClick={() => setIsUserModalOpen(false)}><X size={20} className="text-gray-400"/></button></div>
                                <form onSubmit={handleCreateUser} className="space-y-4">
                                    <div><label className="text-xs font-bold text-gray-400 uppercase">Email</label><input type="email" required className="w-full bg-gray-50 border p-3 rounded-lg outline-none" value={newUserEmail} onChange={e => setNewUserEmail(e.target.value)} /></div>
                                    <div><label className="text-xs font-bold text-gray-400 uppercase">Senha</label><input type="password" required className="w-full bg-gray-50 border p-3 rounded-lg outline-none" value={newUserPass} onChange={e => setNewUserPass(e.target.value)} /></div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-400 uppercase">Cargo / Fun√ß√£o</label>
                                        <select className="w-full bg-gray-50 border p-3 rounded-lg outline-none" value={newUserRole} onChange={e => setNewUserRole(e.target.value)}>
                                            <option>Atendente</option>
                                            <option>Gerente</option>
                                            <option>T√©cnico Auxiliar</option>
                                            <option>Caixa</option>
                                        </select>
                                    </div>
                                    <Button type="submit" className="w-full" disabled={saving}>{saving ? 'Criando...' : 'Cadastrar'}</Button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* MODAL PRINCIPAL */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center">
                            <div className="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-2xl h-[95vh] sm:h-[90vh] flex flex-col animate-in shadow-2xl">
                                <div className={`p-4 border-b flex justify-between items-center rounded-t-3xl ${modalMode === 'view' ? 'bg-blue-50' : 'bg-gray-50'}`}>
                                    <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2">{modalMode === 'view' ? <Eye size={20} className="text-blue-600"/> : <Edit size={20} className="text-orange-600"/>}{modalMode === 'view' ? `OS #${formData.osNumber}` : (editingId ? 'Editar OS' : 'Nova OS')}</h3>
                                    <div className="flex gap-2">
                                        {modalMode === 'view' && <button onClick={() => openReceipt(formData)} className="p-2 bg-white rounded-full text-gray-500 shadow-sm"><Printer size={20}/></button>}
                                        <button onClick={() => setIsModalOpen(false)} className="p-2 bg-white rounded-full text-gray-500 shadow-sm"><X size={20}/></button>
                                    </div>
                                </div>
                                <div className="p-5 overflow-y-auto flex-1 bg-white space-y-6">
                                    {modalMode === 'view' ? (
                                        <div className="space-y-6">
                                            <div className="flex flex-col items-center gap-2"><StatusBadge status={formData.status} />{formData.status === 'Conclu√≠do' && formData.dateExit && (<WarrantyBadge dateExit={formData.dateExit} days={formData.warrantyDays} />)}</div>
                                            <div className="bg-gray-50 p-4 rounded-2xl border border-gray-100"><h4 className="text-xs font-bold text-gray-400 uppercase mb-3">Dados do Aparelho</h4><div className="space-y-2 text-sm"><div className="flex justify-between"><span className="text-gray-500">Cliente:</span> <span className="font-bold text-gray-800">{formData.clientName}</span></div><div className="flex justify-between"><span className="text-gray-500">Telefone:</span> <span className="font-bold text-gray-800">{formData.clientPhone || '-'}</span></div><div className="flex justify-between"><span className="text-gray-500">Modelo:</span> <span className="font-bold text-gray-800">{formData.deviceModel}</span></div><div className="flex justify-between"><span className="text-gray-500">Data Ent:</span> <span className="font-bold text-gray-800">{formatDateBR(formData.dateEntry)}</span></div></div></div>
                                            <div className="bg-gray-50 p-4 rounded-2xl border border-gray-100"><h4 className="text-xs font-bold text-gray-400 uppercase mb-3">Defeito e Servi√ßo</h4><p className="text-gray-800 font-medium mb-2"><span className="text-gray-400 text-xs block">Defeito:</span>{formData.problem}</p>{formData.serviceDone && <p className="text-gray-800 font-medium"><span className="text-gray-400 text-xs block">Servi√ßo:</span>{formData.serviceDone}</p>}</div>
                                            <div className="bg-gray-50 p-4 rounded-2xl border border-gray-100"><h4 className="text-xs font-bold text-gray-400 uppercase mb-3">Custos Extras / Brindes</h4>{formData.extraCosts && formData.extraCosts.length > 0 ? (<ul className="space-y-1">{formData.extraCosts.map((extra, idx) => (<li key={idx} className="flex justify-between text-sm"><span>{extra.description}</span><span className="font-bold text-red-500">- {formatCurrency(extra.amount)}</span></li>))}</ul>) : <span className="text-sm text-gray-400">Nenhum custo extra.</span>}</div>
                                            <div className="bg-gray-50 p-4 rounded-2xl border border-gray-100"><h4 className="text-xs font-bold text-gray-400 uppercase mb-3">Pagamentos</h4><div className="flex justify-between items-center mb-2"><span className="text-gray-500">Valor Total:</span><span className="text-xl font-bold text-green-700">{formatCurrency(formData.price)}</span></div>{formData.payments && formData.payments.map((p, i) => (<div key={i} className="flex justify-between text-sm text-gray-600"><span>{p.method}</span><span>{formatCurrency(p.amount)}</span></div>))}</div>
                                        </div>
                                    ) : (
                                        <form id="osForm" className="space-y-6">
                                            <section className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 space-y-3"><h4 className="text-xs font-bold text-blue-500 uppercase tracking-wider mb-2 flex items-center gap-1"><User size={12}/> Cliente e Prazos</h4><input className="w-full bg-gray-50 border-gray-200 border p-3 rounded-xl font-medium outline-none" value={formData.clientName} onChange={e => setFormData({...formData, clientName: e.target.value})} placeholder="Nome do Cliente" /><div className="relative"><Phone className="absolute left-3 top-3 text-gray-400" size={18} /><input type="tel" className="w-full bg-gray-50 border-gray-200 border p-3 pl-10 rounded-xl font-medium outline-none" value={formData.clientPhone} onChange={e => setFormData({...formData, clientPhone: e.target.value})} placeholder="Telefone (WhatsApp)" /></div><div className="grid grid-cols-2 gap-3"><div><label className="text-[10px] font-bold text-gray-400 uppercase">Entrada</label><input type="date" className="w-full bg-gray-50 border-gray-200 border p-3 rounded-xl font-medium outline-none text-sm" value={formData.dateEntry} onChange={e => setFormData({...formData, dateEntry: e.target.value})} /></div><div><label className="text-[10px] font-bold text-gray-400 uppercase">Sa√≠da</label><input type="date" className="w-full bg-gray-50 border-gray-200 border p-3 rounded-xl font-medium outline-none text-sm" value={formData.dateExit} onChange={e => setFormData({...formData, dateExit: e.target.value})} /></div></div><div className="grid grid-cols-2 gap-3"><select className="bg-gray-50 border-gray-200 border p-3 rounded-xl font-medium outline-none" value={formData.deviceType} onChange={e => setFormData({...formData, deviceType: e.target.value})}><option>Smartphone</option><option>Notebook</option><option>Tablet</option><option>Console</option></select><input className="bg-gray-50 border-gray-200 border p-3 rounded-xl font-medium outline-none" value={formData.deviceModel} onChange={e => setFormData({...formData, deviceModel: e.target.value})} placeholder="Modelo (Ex: S20)" /></div></section>
                                            <section className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><h4 className="text-xs font-bold text-orange-500 uppercase tracking-wider mb-3 flex items-center gap-1"><AlertTriangle size={12}/> Estado ao Chegar</h4><div className="grid grid-cols-3 gap-2"><CheckItem label="N√£o Liga" icon={Power} checked={formData.checklist?.wontTurnOn} onChange={v => setFormData({...formData, checklist: {...formData.checklist, wontTurnOn: v}})} /><CheckItem label="Tela Queb." icon={Smartphone} checked={formData.checklist?.screenBroken} onChange={v => setFormData({...formData, checklist: {...formData.checklist, screenBroken: v}})} /><CheckItem label="Tampa Queb." icon={ShieldAlert} checked={formData.checklist?.backBroken} onChange={v => setFormData({...formData, checklist: {...formData.checklist, backBroken: v}})} /><CheckItem label="N√£o Carrega" icon={BatteryCharging} checked={formData.checklist?.notCharging} onChange={v => setFormData({...formData, checklist: {...formData.checklist, notCharging: v}})} /><CheckItem label="Sem Wifi" icon={Wifi} checked={formData.checklist?.noWifi} onChange={v => setFormData({...formData, checklist: {...formData.checklist, noWifi: v}})} /><CheckItem label="C√¢mera Ruim" icon={Camera} checked={formData.checklist?.cameraBad} onChange={v => setFormData({...formData, checklist: {...formData.checklist, cameraBad: v}})} /></div></section>
                                            <section className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><h4 className="text-xs font-bold text-purple-500 uppercase tracking-wider mb-3 flex items-center gap-1"><Lock size={12}/> Desbloqueio</h4><div className="flex bg-gray-50 p-1 rounded-lg mb-3"><button type="button" onClick={() => setFormData({...formData, passwordType: 'none'})} className={`flex-1 py-1.5 text-xs font-bold rounded-md ${formData.passwordType === 'none' ? 'bg-white shadow text-gray-800' : 'text-gray-400'}`}>Sem Senha</button><button type="button" onClick={() => setFormData({...formData, passwordType: 'text'})} className={`flex-1 py-1.5 text-xs font-bold rounded-md ${formData.passwordType === 'text' ? 'bg-white shadow text-gray-800' : 'text-gray-400'}`}>Pin/Texto</button><button type="button" onClick={() => setFormData({...formData, passwordType: 'pattern'})} className={`flex-1 py-1.5 text-xs font-bold rounded-md ${formData.passwordType === 'pattern' ? 'bg-white shadow text-gray-800' : 'text-gray-400'}`}>Padr√£o</button></div>{formData.passwordType === 'text' && (<input className="w-full bg-gray-50 border-gray-200 border p-3 rounded-xl font-medium outline-none" value={formData.passwordText} onChange={e => setFormData({...formData, passwordText: e.target.value})} placeholder="Digite a senha..." />)}{formData.passwordType === 'pattern' && (<PatternLock value={formData.passwordPattern} onChange={v => setFormData({...formData, passwordPattern: v})} />)}</section>
                                            <section className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 space-y-3"><h4 className="text-xs font-bold text-green-600 uppercase tracking-wider mb-2 flex items-center gap-1"><DollarSign size={12}/> Financeiro e Garantia</h4><div><label className="text-[10px] font-bold text-gray-400 uppercase">Garantia (dias)</label><select className="w-full bg-gray-50 border-gray-200 border p-3 rounded-xl font-medium outline-none" value={formData.warrantyDays} onChange={e => setFormData({...formData, warrantyDays: e.target.value})}><option value="0">Sem Garantia</option><option value="7">7 Dias</option><option value="30">30 Dias</option><option value="90">90 Dias (Padr√£o)</option><option value="180">180 Dias</option></select></div><div><label className="text-[10px] font-bold text-gray-400 uppercase">Defeito</label><textarea className="w-full bg-gray-50 border-gray-200 border p-3 rounded-xl font-medium outline-none resize-none text-sm" rows="2" value={formData.problem} onChange={e => setFormData({...formData, problem: e.target.value})} placeholder="Relato do cliente"></textarea></div><div><label className="text-[10px] font-bold text-gray-400 uppercase">Servi√ßo Realizado</label><textarea className="w-full bg-gray-50 border-gray-200 border p-3 rounded-xl font-medium outline-none resize-none text-sm" rows="2" value={formData.serviceDone} onChange={e => setFormData({...formData, serviceDone: e.target.value})} placeholder="O que foi feito?"></textarea></div><div className="grid grid-cols-2 gap-3 pt-2"><div><label className="text-[10px] font-bold text-gray-400 uppercase">Valor Total (R$)</label><input type="number" step="0.01" className="w-full bg-green-50 border-green-100 border p-3 rounded-xl font-bold text-green-700 outline-none text-lg" value={formData.price} onChange={e => setFormData({...formData, price: e.target.value})} placeholder="0.00" /></div><div><label className="text-[10px] font-bold text-gray-400 uppercase">Custo Pe√ßa (R$)</label><input type="number" step="0.01" className="w-full bg-red-50 border-red-100 border p-3 rounded-xl font-bold text-red-700 outline-none text-lg" value={formData.cost} onChange={e => setFormData({...formData, cost: e.target.value})} placeholder="0.00" /></div></div><div className="pt-2 border-t border-gray-100"><label className="text-[10px] font-bold text-gray-400 uppercase mb-2 block flex items-center gap-1"><Gift size={10}/> Custos Extras / Brindes</label><div className="space-y-2 mb-3">{(formData.extraCosts || []).map((extra, idx) => (<div key={idx} className="flex justify-between items-center bg-gray-50 p-2 rounded-lg text-sm"><span>{extra.description}</span><div className="flex items-center gap-3"><span className="font-bold text-red-500">- {formatCurrency(extra.amount)}</span><button onClick={() => removeExtraCost(idx)} type="button" className="text-gray-400"><Trash2 size={14}/></button></div></div>))}</div><div className="flex gap-2"><input type="text" className="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-xs outline-none" placeholder="Ex: Pel√≠cula" value={newExtraCostDesc} onChange={e => setNewExtraCostDesc(e.target.value)} /><input type="number" step="0.01" className="w-20 bg-gray-50 border border-gray-200 rounded-lg px-2 py-2 text-xs outline-none" placeholder="Valor" value={newExtraCostAmount} onChange={e => setNewExtraCostAmount(e.target.value)} /><button type="button" onClick={addExtraCost} className="bg-red-500 text-white p-2 rounded-lg"><Plus size={16}/></button></div></div><div className="pt-2 border-t border-gray-100"><label className="text-[10px] font-bold text-gray-400 uppercase mb-2 block">Pagamentos</label><div className="space-y-2 mb-3">{(formData.payments || []).map((pay, idx) => (<div key={idx} className="flex justify-between items-center bg-gray-50 p-2 rounded-lg text-sm"><div className="flex items-center gap-2">{pay.method === 'Pix' ? <Share2 size={14} className="text-teal-500"/> : pay.method === 'Dinheiro' ? <Banknote size={14} className="text-green-500"/> : <CreditCard size={14} className="text-blue-500"/>}<span>{pay.method}</span></div><div className="flex items-center gap-3"><span className="font-bold">{formatCurrency(pay.amount)}</span><button onClick={() => removePayment(idx)} type="button" className="text-red-400"><Trash2 size={14}/></button></div></div>))}</div><div className="flex gap-2"><select className="bg-gray-50 border border-gray-200 rounded-lg px-2 text-xs outline-none w-24" value={newPaymentMethod} onChange={e => setNewPaymentMethod(e.target.value)}><option>Pix</option><option>Dinheiro</option><option>Cr√©dito</option><option>D√©bito</option></select><input type="number" step="0.01" className="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none" placeholder="Valor" value={newPaymentAmount} onChange={e => setNewPaymentAmount(e.target.value)} /><button type="button" onClick={addPayment} className="bg-blue-600 text-white p-2 rounded-lg"><Plus size={16}/></button></div><div className="mt-3 flex justify-between items-center bg-gray-50 p-3 rounded-xl"><span className="text-xs font-bold text-gray-500 uppercase">Falta Pagar</span><span className={`text-lg font-bold ${((parseFloat(formData.price) || 0) - (formData.payments || []).reduce((acc, curr) => acc + (curr.amount || 0), 0)) > 0 ? 'text-red-500' : 'text-green-600'}`}>{formatCurrency((parseFloat(formData.price) || 0) - (formData.payments || []).reduce((acc, curr) => acc + (curr.amount || 0), 0))}</span></div></div></section>
                                            <section className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><label className="text-xs font-bold text-gray-400 uppercase mb-2 block">Status Atual</label><div className="flex flex-wrap gap-2">{['Aberto', 'Em An√°lise', 'Aguardando Pe√ßa', 'Conclu√≠do', 'Cancelado'].map(s => (<button type="button" key={s} onClick={() => setFormData({...formData, status: s})} className={`px-3 py-2 rounded-lg text-xs font-bold border transition-all active:scale-95 ${formData.status === s ? 'bg-slate-800 text-white border-slate-800 shadow-md' : 'bg-white text-slate-600 border-gray-200 hover:bg-gray-50'}`}>{s}</button>))}</div></section>
                                            <div className="h-10"></div>
                                        </form>
                                    )}
                                </div>
                                {modalMode !== 'view' && <div className="p-4 border-t bg-white pb-safe-bottom"><Button onClick={handleSave} className="w-full text-lg shadow-blue-500/20 py-4" disabled={saving}>{saving ? 'Salvando...' : 'Salvar OS'}</Button></div>}
                            </div>
                        </div>
                    )}

                    {isDeleteModalOpen && <div className="fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4"><div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-in text-center"><div className="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><AlertTriangle size={32} /></div><h3 className="text-xl font-bold text-gray-800 mb-2">Excluir OS?</h3><p className="text-gray-500 mb-6 text-sm">Essa a√ß√£o n√£o pode ser desfeita.</p><div className="flex gap-3"><Button variant="secondary" onClick={() => setIsDeleteModalOpen(false)} className="flex-1">Cancelar</Button><Button variant="destructive" onClick={confirmDelete} className="flex-1">Excluir</Button></div></div></div>}

                    {/* MODAL RECIBO */}
                    {receiptData && (
                        <div id="receipt-overlay" className="fixed inset-0 z-[100] bg-white flex flex-col animate-in">
                            <div className="no-print p-4 bg-slate-900 text-white flex justify-between items-center shadow-lg"><h3 className="font-bold flex items-center gap-2"><FileText size={20}/> Visualizar Recibo</h3><div className="flex gap-3"><button onClick={printReceipt} className="bg-green-600 px-4 py-2 rounded-lg font-bold text-sm shadow-sm flex items-center gap-2 active:scale-95"><Printer size={16}/> Imprimir</button><button onClick={closeReceipt} className="bg-slate-700 px-3 py-2 rounded-lg text-sm font-bold active:scale-95"><X size={18}/></button></div></div>
                            <div className="flex-1 overflow-y-auto bg-gray-100 p-4 flex justify-center"><div id="receipt-content" className="bg-white w-full max-w-[350px] shadow-xl p-6 text-black font-mono text-sm leading-relaxed h-fit border border-gray-200"><h2 className="text-center font-bold text-xl mb-1 uppercase tracking-widest">SmartOS</h2><p className="text-center text-xs text-gray-500 mb-4">Assist√™ncia T√©cnica Especializada</p><div className="border-b-2 border-dashed border-gray-300 my-4"></div><div className="flex justify-between font-bold text-lg mb-2"><span>OS #{receiptData.osNumber}</span><span>{formatDateBR(new Date().toISOString().split('T')[0])}</span></div><div className="space-y-1 mb-4"><p><span className="font-bold">CLIENTE:</span> {receiptData.clientName}</p><p><span className="font-bold">TELEFONE:</span> {receiptData.clientPhone || 'N/A'}</p><p><span className="font-bold">APARELHO:</span> {receiptData.deviceType} {receiptData.deviceModel}</p><p><span className="font-bold">DEFEITO:</span> {receiptData.problem}</p>{Object.values(receiptData.checklist || {}).some(x=>x) && (<p className="text-xs mt-2"><span className="font-bold">OBS. ENTRADA:</span> {Object.entries(receiptData.checklist).filter(([_,v])=>v).map(([k])=>k === 'wontTurnOn'?'N√£o Liga':k==='screenBroken'?'Tela Queb.':k==='backBroken'?'Tampa Queb.':k==='notCharging'?'N√£o Carrega':k==='noWifi'?'Sem Wifi':'C√¢mera Ruim').join(', ')}</p>)}</div><div className="border-b-2 border-dashed border-gray-300 my-4"></div><div className="space-y-2"><div className="flex justify-between"><span>Total Servi√ßo</span> <span className="font-bold">R$ {parseFloat(receiptData.price || 0).toFixed(2)}</span></div><div className="flex justify-between text-gray-500"><span>Descontos/Pagos</span> <span>- R$ {(receiptData.payments || []).reduce((a,c)=>a+c.amount,0).toFixed(2)}</span></div><div className="border-t border-gray-200 my-1"></div><div className="flex justify-between text-lg font-bold"><span>A PAGAR</span> <span>R$ {(parseFloat(receiptData.price || 0) - (receiptData.payments || []).reduce((a,c)=>a+c.amount,0)).toFixed(2)}</span></div></div><div className="border-b-2 border-dashed border-gray-300 my-4"></div><div className="text-[10px] text-justify text-gray-500 leading-tight"><p className="font-bold mb-1">TERMOS DE GARANTIA:</p><p>1. Garantia de <span className="font-bold text-black">{receiptData.warrantyDays || 90} dias</span> v√°lida at√© {getWarrantyInfo(receiptData.dateExit || new Date().toISOString(), receiptData.warrantyDays || 90)?.expiryDate}.</p><p>2. A garantia n√£o cobre danos causados por mau uso, contato com l√≠quidos ou quedas.</p><p>3. Aparelhos n√£o retirados em at√© 90 dias ser√£o vendidos para custeio (Art. 1.275 CC).</p></div><div className="mt-12 border-t border-black pt-2 text-center text-xs">Assinatura do Cliente</div><p className="text-center mt-6 font-bold text-xs">Obrigado pela prefer√™ncia!</p></div></div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<SmartOSApp />);
    </script>

</body>
</html>
